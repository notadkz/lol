# Cải thiện hệ thống thanh toán và thêm tính năng cập nhật số dư

## Vấn đề đã phát hiện

1. **Lỗi xử lý phản hồi từ PayOS API**:

   - API PayOS trả về mã lỗi "20" với thông báo "Thông tin truyền lên không đúng"
   - Code cố gắng truy cập `payosResponseData.data.checkoutUrl` khi `data` là `null`
   - Dẫn đến lỗi: `TypeError: Cannot read properties of null (reading 'checkoutUrl')`

2. **Thiếu cơ chế cập nhật số dư người dùng**:
   - Sau khi thanh toán thành công, số dư (balance) của người dùng không được cập nhật
   - Không có webhook để PayOS thông báo khi thanh toán thành công
   - Thiếu trang xác nhận thanh toán với UI/UX phù hợp

## Giải pháp đã thực hiện

### 1. Cải thiện API tạo thanh toán (`/api/payos/create-payment`)

- Thêm kiểm tra `payosResponseData.code !== "00"` để phát hiện lỗi từ PayOS
- Kiểm tra xem trường `data` có tồn tại và có chứa `checkoutUrl` không
- Lưu đầy đủ thông tin phản hồi API vào trường `apiResponse` của giao dịch
- Cập nhật phản hồi lỗi với mã lỗi và thông báo rõ ràng hơn
- Trả về ID giao dịch (`transactionId`) để theo dõi trong quá trình thanh toán

```typescript
// Lưu phản hồi API vào giao dịch để debug
await prisma.topUpTransaction.update({
  where: { id: transaction.id },
  data: {
    apiResponse: JSON.stringify(payosResponseData),
  },
});

// Kiểm tra đầy đủ các điều kiện lỗi
if (
  !payosResponse.ok ||
  payosResponseData.code !== "00" ||
  !payosResponseData.data
) {
  // Cập nhật trạng thái và ghi chú lỗi
  await prisma.topUpTransaction.update({
    where: { id: transaction.id },
    data: {
      status: "FAILED",
      processingNote: `Lỗi từ PayOS: ${
        payosResponseData.desc || "Không rõ lỗi"
      }`,
    },
  });
  // ...
}
```

### 2. Tạo Webhook PayOS (`/api/payos/webhook`)

Đã tạo một API endpoint để nhận và xử lý thông báo thanh toán từ PayOS:

- Xác thực chữ ký webhook từ PayOS để đảm bảo tính an toàn
- Tìm và kiểm tra thông tin giao dịch trong database
- Xử lý các trường hợp khác nhau của sự kiện thanh toán (`payment.succeeded`)
- Sử dụng giao dịch cơ sở dữ liệu `$transaction` để đảm bảo tính toàn vẹn dữ liệu
- Cập nhật số dư người dùng khi thanh toán thành công

```typescript
// Cập nhật transaction và tăng số dư người dùng
const result = await prisma.$transaction(async (prismaClient) => {
  // 1. Cập nhật trạng thái giao dịch
  const updatedTransaction = await prismaClient.topUpTransaction.update({
    where: { id: transaction.id },
    data: {
      status: "SUCCESS",
      // ...
    },
  });

  // 2. Cập nhật số dư người dùng
  const updatedUser = await prismaClient.user.update({
    where: { id: transaction.userId },
    data: {
      balance: {
        increment: new Decimal(amountPaid),
      },
    },
  });

  // 3. Tạo bản ghi lịch sử giao dịch
  const transactionHistory = await prismaClient.transactionHistory.create({
    data: {
      userId: transaction.userId,
      type: "TOP_UP",
      amount: new Decimal(amountPaid),
      // ...
    },
  });

  return { updatedTransaction, updatedUser, transactionHistory };
});
```

### 3. Tạo API Callback (`/api/payos/success`)

Đã tạo API endpoint để xử lý việc người dùng quay lại sau khi thanh toán:

- Phân tích URL parameters (`orderCode`, `status`) từ PayOS
- Xử lý các trạng thái khác nhau: `PAID`, `CANCEL`, `ERROR`
- Chuyển hướng người dùng đến trang thành công hoặc trang lỗi phù hợp
- Cập nhật thông tin giao dịch với ghi chú về việc người dùng quay lại

### 4. Tạo trang xác nhận thanh toán (`/payment/success/page.tsx`)

Đã tạo trang hiển thị kết quả thanh toán với những tính năng:

- Hiển thị trạng thái thanh toán với màu sắc và biểu tượng phù hợp
- Hỗ trợ các trạng thái: `completed`, `processing`, `pending`
- Hiển thị thông báo tương ứng với từng trạng thái
- Cung cấp các liên kết để nạp thêm tiền, xem lịch sử giao dịch, hoặc quay lại trang chủ
- Tự động chuyển hướng khi cần thiết

## Quy trình thanh toán đầy đủ

1. **Tạo giao dịch**:

   - Người dùng nhập số tiền muốn nạp và gửi yêu cầu
   - Hệ thống tạo giao dịch trong database với trạng thái `PENDING`
   - Gọi API PayOS để tạo mã QR/payment link

2. **Thanh toán**:

   - Người dùng quét mã QR hoặc chuyển hướng đến trang thanh toán
   - Hoàn thành thanh toán trên cổng PayOS

3. **Xác nhận thanh toán**:

   - PayOS gửi webhook đến hệ thống khi thanh toán thành công
   - Hệ thống xác thực webhook và cập nhật trạng thái giao dịch
   - Cập nhật số dư người dùng và tạo bản ghi lịch sử giao dịch

4. **Người dùng quay lại**:
   - Người dùng được chuyển hướng về trang xác nhận của hệ thống
   - Hệ thống kiểm tra trạng thái giao dịch và hiển thị thông báo phù hợp

## Kết quả và lợi ích

1. **Hệ thống thanh toán tin cậy hơn**:

   - Xử lý đúng các phản hồi lỗi từ PayOS
   - Ghi log đầy đủ thông tin để dễ dàng gỡ lỗi
   - Sử dụng giao dịch cơ sở dữ liệu để đảm bảo toàn vẹn dữ liệu

2. **Trải nghiệm người dùng tốt hơn**:

   - Thông báo rõ ràng về trạng thái thanh toán
   - Giao diện trực quan với màu sắc và biểu tượng dễ hiểu
   - Các tùy chọn liên quan sau khi thanh toán (nạp thêm, xem lịch sử)

3. **Tự động hóa**:
   - Số dư người dùng được cập nhật tự động sau khi thanh toán thành công
   - Không cần thủ công xác nhận các giao dịch nạp tiền
   - Tạo lịch sử giao dịch đầy đủ để tra cứu sau này

## Công việc tiếp theo

1. **Cải thiện xử lý lỗi**:

   - Thêm cơ chế thử lại tự động cho các giao dịch bị lỗi tạm thời
   - Thông báo qua email cho admin khi có giao dịch gặp sự cố

2. **Thêm tính năng**:

   - Thông báo qua email cho người dùng khi giao dịch thành công
   - Xuất hóa đơn/biên lai cho các giao dịch nạp tiền
   - Thêm thống kê và báo cáo tài chính cho quản trị viên

3. **Cải thiện bảo mật**:
   - Lưu log chi tiết các yêu cầu và phản hồi webhook
   - Thêm các biện pháp chống gian lận và phát hiện giao dịch đáng ngờ
   - Mã hóa dữ liệu nhạy cảm trong cơ sở dữ liệu
     </rewritten_file>
