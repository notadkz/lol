# Sửa lỗi trong hệ thống thanh toán PayOS

## Vấn đề

Trong quá trình tích hợp hệ thống thanh toán PayOS vào marketplace, đã gặp một số lỗi chính:

1. **Phản hồi API rỗng**: API `/api/payos/create-payment` trả về một object rỗng `{}` thay vì dữ liệu thanh toán hợp lệ, khiến component gặp lỗi khi hiển thị thông tin thanh toán.

2. **Lỗi khi hiển thị mã QR**: Lỗi HTTP 400 (Bad Request) khi gọi API tạo mã QR với `api.qrserver.com`.

3. **Lỗi sử dụng hook usePayOS**: Hook này không được sử dụng đúng cách trong React, gây ra lỗi "Cannot read properties of undefined (reading 'bankName')".

## Giải pháp

### 1. Cải thiện API endpoint

- Cập nhật định dạng dữ liệu trả về từ API để phù hợp với kiểu `PaymentResponse`
- Thêm kiểm tra session và validation ở phía server
- Cấu trúc lại dữ liệu gửi đến PayOS và xử lý phản hồi
- Thêm mã tham chiếu (reference) duy nhất cho mỗi giao dịch
- Cải thiện logging để dễ debug

### 2. Sửa lỗi hiển thị QR Code

- Thay đổi cách hiển thị QR code, sử dụng base64 string trực tiếp thay vì gọi API bên thứ ba
- Thêm xử lý dự phòng khi không có dữ liệu QR code

### 3. Cải thiện sử dụng PayOS Checkout

- Cấu hình PayOS đúng cách theo React Hooks pattern
- Tạo config một lần và sử dụng hook `usePayOS` đúng cách
- Thêm kiểm tra hợp lệ cho CHECKOUT_URL và các thông số khác
- Thêm phương án dự phòng (fallback) khi PayOS không hoạt động

### 4. Tăng cường xử lý lỗi

- Cải thiện kiểm tra tính hợp lệ của dữ liệu trước khi sử dụng
- Thêm error boundary cho các tình huống ngoại lệ
- Xử lý các trường hợp dữ liệu thiếu hoặc không hợp lệ
- Thêm thông báo lỗi rõ ràng và hữu ích cho người dùng

## Cấu trúc dữ liệu mới của PaymentResponse

```typescript
type PaymentResponse = {
  success: boolean;
  paymentUrl?: string;
  qrCode?: string;
  paymentInfo?: {
    bankName?: string;
    accountNumber?: string;
    accountName?: string;
    amount?: number;
    description?: string;
  };
  reference?: string;
  error?: string;
};
```

## Lưu ý khi sử dụng PayOS Checkout

1. **Hook usePayOS**: Phải được khởi tạo ở cấp cao nhất của component, không được gọi trong event handler.
2. **Base URL**: Luôn xác thực đường dẫn gốc của ứng dụng trong môi trường server-side và client-side.
3. **Xử lý lỗi**: Luôn có phương án dự phòng khi PayOS Checkout không hoạt động.
4. **Logging**: Ghi log đầy đủ để dễ dàng debug.

## Tối ưu hóa trong tương lai

1. Thêm tính năng lưu trữ và quản lý giao dịch trong cơ sở dữ liệu
2. Cải thiện webhook handler để cập nhật trạng thái giao dịch real-time
3. Thêm trang quản lý lịch sử giao dịch
4. Bổ sung tính năng thông báo kết quả giao dịch qua email hoặc thông báo trong ứng dụng
