# Sửa lỗi tích hợp PayOS dựa trên tài liệu chính thức

## Vấn đề gặp phải

Sau khi triển khai integration PayOS, chúng ta gặp các lỗi sau:

1. Lỗi API `/api/payos/create-payment` trả về "Thông tin người dùng không hợp lệ"
2. Request tới API PayOS bị từ chối với lỗi 400 (Bad Request)
3. Lỗi hiển thị QR code với `api.qrserver.com`

## Nguyên nhân

Sau khi kiểm tra kỹ tài liệu chính thức của PayOS, nguyên nhân chính được xác định:

1. **Cấu trúc dữ liệu gửi đến PayOS chưa đúng theo tài liệu**

   - Thiếu một số trường dữ liệu bắt buộc theo yêu cầu của PayOS
   - Format dữ liệu chưa đúng (ví dụ `orderCode` phải là string)

2. **Xác thực người dùng**

   - Xử lý user ID từ session chưa đúng
   - Thiếu kiểm tra user trong database

3. **Xử lý QR code**
   - Không kiểm tra định dạng QR code trả về từ PayOS (base64 hay URL)

## Giải pháp

### 1. Cập nhật API route

Đã cập nhật file `/api/payos/create-payment/route.ts` để:

- Kiểm tra session và user ID kỹ lưỡng hơn
- Xác thực user trong database
- Cấu trúc lại dữ liệu gửi đến PayOS theo đúng tài liệu
  - Thêm các trường `buyerName`, `buyerEmail`, `items`
  - Chuyển `orderCode` sang định dạng string
- Cải thiện xử lý lỗi và logging

### 2. Cải thiện component DepositForm

Đã cập nhật file `components/user/DepositForm.tsx` để:

- Thêm kiểm tra session và hỗ trợ người dùng đăng nhập lại khi session hết hạn
- Tạo hàm `isBase64()` để kiểm tra định dạng QR code
- Tạo hàm `renderQRCode()` để xử lý các loại QR code khác nhau
- Thêm hiển thị thông tin session khi debug
- Thêm trạng thái loading

### 3. Cấu trúc dữ liệu theo tài liệu PayOS

Dữ liệu gửi đến PayOS API cần tuân thủ cấu trúc sau:

```json
{
  "orderCode": "ORDER_123",
  "amount": 100000,
  "description": "Nạp tiền vào ví",
  "cancelUrl": "https://example.com/cancel",
  "returnUrl": "https://example.com/success",
  "buyerName": "Nguyễn Văn A",
  "buyerEmail": "email@example.com",
  "buyerPhone": "0987654321",
  "items": [
    {
      "name": "Nạp tiền vào ví",
      "quantity": 1,
      "price": 100000
    }
  ]
}
```

## Luồng hoạt động của PayOS

Dựa theo tài liệu chính thức, luồng hoạt động của PayOS gồm các bước:

1. Khách hàng thực hiện mua hàng và chọn thanh toán Napas 247 (VietQR)
2. Website gọi API tạo link thanh toán, PayOS trả về link thanh toán
3. Khách hàng được chuyển hướng đến trang checkout và sử dụng ứng dụng ngân hàng quét QR
4. Sau khi thanh toán thành công, PayOS trả kết quả về returnUrl
5. Đồng thời PayOS gửi webhook đến hệ thống merchant để cập nhật trạng thái đơn hàng

## Các lưu ý khi triển khai PayOS

1. **Kiểm tra cấu hình môi trường**

   - Đảm bảo các biến môi trường PAYOS_CLIENT_ID, PAYOS_API_KEY và PAYOS_CHECKSUM_KEY được cấu hình đúng
   - URL API chính thức: `https://api-merchant.payos.vn/v2/payment-requests`

2. **Xử lý session**

   - Đảm bảo session của người dùng còn hiệu lực khi thực hiện thanh toán
   - Cung cấp cơ chế đăng nhập lại khi session hết hạn

3. **QR Code**
   - PayOS có thể trả về QR code dưới dạng base64 string
   - Cần kiểm tra và hiển thị QR code tương ứng

## Tham khảo

- Tài liệu chính thức PayOS: https://payos.vn/docs
- Luồng hoạt động: https://payos.vn/docs#luồng-hoạt-động
- API tạo link thanh toán: https://payos.vn/docs/payment-api
- Webhook: https://payos.vn/docs/webhook
