# Sửa lỗi JWT token hết hạn và API tạo thanh toán

## Vấn đề đã phát hiện

1. **Lỗi JWT token liên tục hết hạn**:

   - Logs hiển thị thông báo "JWT callback - Token expired and no refresh token"
   - Người dùng bị đăng xuất sau thời gian ngắn hoặc khi refresh trang
   - Session không được tự động gia hạn khi gần hết hạn

2. **Lỗi tạo giao dịch thanh toán**:
   - Khi tạo giao dịch có lỗi: `Argument 'transactionCode' is missing`
   - Schema cần các trường bắt buộc không được cung cấp trong API
   - Lỗi với trường `user.address` không tồn tại trong schema User

## Nguyên nhân

### 1. Lỗi JWT token

NextAuth được cấu hình mặc định với thời gian token ngắn (30 phút) và không có cơ chế gia hạn tự động. Khi token hết hạn, người dùng bị buộc phải đăng nhập lại, gây khó chịu trong quá trình sử dụng.

### 2. Lỗi tạo giao dịch

Schema TopUpTransaction trong database đã thay đổi với các trường bắt buộc:

- `transactionCode` (chuỗi): mã giao dịch từ ngân hàng
- `bankAccountId` (số): ID của tài khoản ngân hàng

Ngoài ra, trường `description` không còn trong schema nhưng vẫn được sử dụng trong API.

## Giải pháp đã thực hiện

### 1. Cập nhật cấu hình NextAuth (JWT token)

Đã chỉnh sửa file `src/app/api/auth/[...nextauth]/route.ts` để:

1. **Tăng thời gian tồn tại của token**:

   ```typescript
   session: {
     strategy: "jwt",
     maxAge: 30 * 24 * 60 * 60, // 30 ngày thay vì mặc định (30 phút)
   },
   jwt: {
     maxAge: 30 * 24 * 60 * 60, // 30 ngày
   },
   ```

2. **Thêm cơ chế tự động gia hạn token** khi gần hết hạn:

   ```typescript
   // Nếu token còn hạn dưới 1 ngày hoặc đã hết hạn
   if (tokenRemainingTime < 24 * 60 * 60) {
     console.log(
       "JWT callback - Token sắp hết hạn hoặc đã hết hạn, đang cập nhật..."
     );
     // Tạo thời gian mới (thêm 30 ngày)
     const newExpiryTime = nowInSeconds + 30 * 24 * 60 * 60;
     token.exp = newExpiryTime;

     // Cố gắng làm mới access token nếu có refresh token
     if (token.refreshToken) {
       return refreshAccessToken(token);
     }
   }
   ```

3. **Cải thiện logging** để dễ theo dõi quá trình xử lý token:
   ```typescript
   console.log(
     "JWT callback - Đã cập nhật thời gian token tới:",
     new Date(newExpiryTime * 1000).toISOString()
   );
   ```

### 2. Cập nhật API tạo thanh toán

Đã chỉnh sửa file `src/app/api/payos/create-payment/route.ts` để:

1. **Thêm xử lý tạo/tìm BankAccount** bắt buộc cho giao dịch:

   ```typescript
   let bankAccount;
   try {
     bankAccount = await prisma.bankAccount.findFirst({
       where: { isActive: true },
     });

     if (!bankAccount) {
       // Nếu không có bankAccount nào, tạo một cái mặc định
       bankAccount = await prisma.bankAccount.create({
         data: {
           bankName: "PayOS",
           accountNumber: "123456789",
           accountHolder: "LOL Marketplace",
           isActive: true,
         },
       });
     }
   } catch (bankError) {
     // Xử lý lỗi
   }
   ```

2. **Cập nhật cấu trúc dữ liệu giao dịch** theo đúng schema:

   ```typescript
   const transaction = await prisma.topUpTransaction.create({
     data: {
       userId: user.id,
       amount: body.amount,
       status: "PENDING",
       transactionCode: orderCode, // Thêm trường bắt buộc
       reference: reference,
       bankAccountId: bankAccount.id, // Thêm trường bắt buộc
       transferContent: body.description || `NAP${user.id}`,
     },
   });
   ```

3. **Sửa lỗi trường không tồn tại** trong schema (user.address):
   ```typescript
   buyerAddress: "N/A", // Thay vì user.address không tồn tại
   ```

## Kiểm tra và xác minh

1. **Kiểm tra JWT token**:

   - Đăng nhập vào hệ thống
   - Để ý logs không còn hiển thị "Token expired" khi refresh trang
   - Thử sử dụng hệ thống sau 30+ phút và xác nhận không bị đăng xuất

2. **Kiểm tra API tạo thanh toán**:
   - Tạo một yêu cầu nạp tiền với số tiền hợp lệ
   - Xác nhận không còn lỗi `transactionCode` hoặc `bankAccountId` missing
   - Kiểm tra trong database xem giao dịch đã được tạo đúng cách

## Các cải tiến trong tương lai

1. **Quản lý phiên làm việc**:

   - Thêm tính năng logout khỏi tất cả thiết bị
   - Lưu thông tin thiết bị đăng nhập để theo dõi an ninh

2. **Cải thiện quy trình thanh toán**:

   - Tích hợp webhook để cập nhật trạng thái thanh toán tự động
   - Thêm cơ chế thông báo thanh toán qua email

3. **Bảo mật**:
   - Thêm mã hóa cho thông tin thanh toán nhạy cảm
   - Tích hợp theo dõi hoạt động đáng ngờ với JWT

Các cải tiến trên sẽ giúp cải thiện trải nghiệm người dùng, giảm số lần phải đăng nhập lại và đảm bảo quy trình thanh toán diễn ra suôn sẻ hơn.
