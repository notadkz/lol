# Tích hợp PayOS vào Hệ thống Marketplace

## Giới thiệu

Tài liệu này mô tả quá trình tích hợp cổng thanh toán PayOS vào dự án LOL Marketplace. PayOS là một cổng thanh toán cho phép nhận thanh toán qua chuyển khoản ngân hàng thông qua mã QR VietQR mà không cần qua trung gian và không có phí giao dịch. Đây là giải pháp thanh toán phù hợp cho người dùng Việt Nam.

## Các tệp được tạo/chỉnh sửa

1. **`src/lib/payos.ts`**: Thư viện để tương tác với API của PayOS
2. **`.env.example`**: Thêm cấu hình môi trường cho PayOS
3. **`src/app/api/payos/create-payment/route.ts`**: API route để tạo link thanh toán
4. **`src/app/api/payos/webhook/route.ts`**: API route để nhận và xử lý webhook từ PayOS
5. **`src/app/payment/success/page.tsx`**: Trang hiển thị khi thanh toán thành công
6. **`src/app/payment/cancel/page.tsx`**: Trang hiển thị khi hủy thanh toán
7. **`src/app/user/deposit/page.tsx`**: Trang nạp tiền cho người dùng
8. **`src/components/user/DepositForm.tsx`**: Component form nạp tiền

## Luồng hoạt động

1. **Người dùng nhập số tiền muốn nạp vào tài khoản**

   - Người dùng truy cập trang `/user/deposit`
   - Nhập số tiền muốn nạp và các thông tin cần thiết
   - Nhấn nút "Tạo mã thanh toán"

2. **Hệ thống tạo link thanh toán**

   - Frontend gửi request đến API `/api/payos/create-payment`
   - Backend gọi đến API của PayOS để tạo link thanh toán
   - Lưu thông tin giao dịch vào bảng `TopUpTransaction` với trạng thái `PENDING`
   - Trả về thông tin thanh toán và mã QR cho frontend

3. **Người dùng thanh toán**

   - Người dùng quét mã QR bằng ứng dụng ngân hàng hoặc nhấn nút "Thanh toán ngay" để mở trang thanh toán
   - Hoàn tất thanh toán trên ứng dụng ngân hàng

4. **PayOS gửi kết quả thanh toán**

   - PayOS gửi webhook thông báo kết quả thanh toán đến endpoint `/api/payos/webhook`
   - Hệ thống kiểm tra chữ ký và xác thực dữ liệu
   - Nếu thanh toán thành công, cập nhật trạng thái giao dịch thành `SUCCESS` và cộng tiền vào tài khoản người dùng
   - Tạo bản ghi trong `TransactionHistory` (nếu có sẵn) để lưu lịch sử giao dịch

5. **Người dùng được chuyển hướng**
   - Sau khi thanh toán, người dùng được chuyển hướng đến trang `/payment/success` hoặc `/payment/cancel` tùy thuộc vào kết quả

## Cấu hình cần thiết

Để tích hợp PayOS, bạn cần cấu hình các biến môi trường sau:

```dotenv
PAYOS_CLIENT_ID=your_payos_client_id
PAYOS_API_KEY=your_payos_api_key
PAYOS_CHECKSUM_KEY=your_payos_checksum_key
PAYOS_BASE_URL=https://api-merchant.payos.vn  # Hoặc URL sandbox cho môi trường test
```

## Tạo tài khoản PayOS

1. Truy cập [PayOS](https://payos.vn) và đăng ký tài khoản
2. Xác thực danh tính (cá nhân hoặc doanh nghiệp)
3. Tạo kênh thanh toán mới
4. Lấy client ID, API key và checksum key từ trang quản lý của PayOS

## Các API PayOS được sử dụng

1. **Tạo link thanh toán**: `POST /v2/payment-requests`
2. **Lấy thông tin link thanh toán**: `GET /v2/payment-requests/{id}`
3. **Hủy link thanh toán**: `POST /v2/payment-requests/{id}/cancel`

## Xử lý webhook

PayOS sẽ gửi webhook đến URL đã đăng ký khi có sự kiện thanh toán. Các sự kiện bao gồm:

- Thanh toán thành công: `PAID`
- Thanh toán thất bại: `FAILED`
- Thanh toán bị hủy: `CANCELLED`

Hệ thống kiểm tra chữ ký webhook bằng hàm `verifyWebhookSignature` trong thư viện `payos.ts` để đảm bảo dữ liệu đến từ PayOS.

## Lưu ý

1. Đảm bảo webhook URL của bạn có thể truy cập được từ internet (hoặc sử dụng công cụ như ngrok để test)
2. Kiểm tra kỹ chữ ký của webhook để đảm bảo an toàn
3. Xử lý các trường hợp lỗi và cập nhật trạng thái giao dịch một cách chính xác

## Thử nghiệm

1. Sử dụng môi trường sandbox của PayOS để thử nghiệm
2. Kiểm tra các trường hợp thanh toán thành công, thất bại và bị hủy
3. Xác minh webhook hoạt động đúng và số dư được cập nhật chính xác

## Tài liệu tham khảo

- [Tài liệu chính thức của PayOS](https://payos.vn/docs/)
- [API Reference của PayOS](https://payos.vn/docs/api/)
- [Hướng dẫn xử lý webhook](https://payos.vn/docs/tich-hop-webhook/kiem-tra-du-lieu-voi-signature/)
